<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>NMDC Samalwar ‚Äì Proposed Model Village Planning Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>



<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:"Segoe UI",Arial,sans-serif}

/* HEADER */
.app-header{
  position:fixed;top:0;left:0;right:0;height:60px;
  background:#0f4c81;color:#fff;
  display:flex;align-items:center;
  padding:0 16px;z-index:3000
}
.app-header img{height:40px;margin-right:12px}
.app-header span{font-size:18px;font-weight:600}

/* MAIN */
.main{
  position:absolute;top:60px;bottom:0;left:0;right:0;
  display:grid;grid-template-columns:1fr 360px
}

/* MAP */
#map{width:100%;height:100%}

/* DASHBOARD */
.dashboard{
  background:#ffffff;
  border-left:1px solid #ddd;
  padding:14px;
  overflow-y:auto
}

/* KPI */
.kpis{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-bottom:14px
}
.kpi{
  background:#0f4c81;color:#fff;
  padding:12px;border-radius:6px;
  text-align:center
}
.kpi span{font-size:12px;opacity:.85}
.kpi h2{font-size:22px}

#categoryButtons button{
  padding:8px;
  border:none;
  border-radius:6px;
  background:#e5e7eb;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
}
#categoryButtons button.active{
  background:#0f4c81;
  color:#fff;
}


/* CHART */
.chart-box{
  background:#f8fafc;
  padding:10px;border-radius:6px;
  margin-bottom:14px
}
.chart-box h4{
  font-size:13px;
  margin-bottom:6px;
  color:#0f4c81
}
.chart-box canvas{
  max-height:280px;
}

@media(max-width:900px){
  .chart-box canvas{
    max-height:220px;
  }
}


#hamburger{
  position: fixed;          /* üî• FIXED TO SCREEN */
  top: 80px;                /* below header */
  left: 14px;
  width: 44px;
  height: 44px;
  background: #0f4c81;
  color: #fff;
  font-size: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  cursor: pointer;
  z-index: 99999;           /* üî• ABOVE DASHBOARD */
  box-shadow: 0 4px 10px rgba(0,0,0,.25);
}


/* LAYER PANEL */
#layerPanel{
  position:absolute;top:130px;left:14px;
  background:#fff;padding:12px 14px;
  font-size:13px;border-radius:6px;
  box-shadow:0 4px 10px rgba(0,0,0,.25);
  display:none;z-index:5000;min-width:220px
}
#layerPanel label{display:block;margin-bottom:6px}

/* MOBILE */
@media(max-width:900px){

  .main{
    grid-template-columns:1fr;
  }

  .dashboard{
    position:fixed;
    bottom:-100%;
    left:0;
    right:0;
    height:70vh;
    background:#ffffff;
    z-index:5000;
    border-top-left-radius:14px;
    border-top-right-radius:14px;
    box-shadow:0 -6px 20px rgba(0,0,0,0.25);
    transition:bottom 0.3s ease;
    overflow-y:auto;
  }

  .dashboard.open{
    bottom:0;
  }
}

/* MOBILE DASHBOARD BUTTON */
#mobileDashBtn{
  display:none;
}

@media(max-width:900px){
  #mobileDashBtn{
    display:flex;
    position:fixed;
    bottom:20px;
    right:20px;
    width:56px;
    height:56px;
    background:#0f4c81;
    color:#ffffff;
    font-size:24px;
    border-radius:50%;
    align-items:center;
    justify-content:center;
    z-index:7000;
    box-shadow:0 6px 16px rgba(0,0,0,0.35);
    cursor:pointer;
  }
}

.kpis {
  display: none;
}

/* EXECUTIVE SUMMARY ‚Äì CMD STYLE (SMALLER TEXT) */
.executive-summary {
  background: #0f4c81;
  color: #ffffff !important;
  border-left: 6px solid #08365c;
  padding: 10px 12px;
}

/* üî• Highlight numbers only inside executive summary */
.executive-summary b {
  font-weight: 800;          /* STRONGER */
  color: #fde047 !important; /* soft yellow highlight */
}


/* Title */
.executive-summary h4 {
  font-size: 13px;
  margin-bottom: 6px;
  color: #ffffff !important;
}

/* Paragraph text */
.executive-summary p {
  font-size: 11.5px;      /* üîΩ reduced */
  line-height: 1.45;      /* compact */
  margin-bottom: 6px;
  color: #ffffff !important;
}

/* Bold text inside */
.executive-summary b {
  font-size: 11.5px;
  font-weight: 600;
  color: #ffffff !important;
}

.map-widgets{
  position:absolute;
  bottom:20px;
  left:20px;
  display:flex;
  gap:12px;
  z-index:4000;
}

.map-widget{
  background:rgba(255,255,255,0.95);
  border-radius:8px;
  padding:10px;
  width:260px;
  height:230px;                 /* ‚úÖ REDUCED */
  box-shadow:0 6px 18px rgba(0,0,0,0.25);
  overflow: visible;             /* ‚úÖ IMPORTANT */
}



.map-widget h4{
  font-size:12px;
  margin-bottom:6px;
  color:#0f4c81;
}

.map-widget canvas {
  width: 100% !important;
  height: 160px !important;
}
/* ================= MAP LEGEND ================= */


#mapLegend h4{
  margin-bottom:6px;
  font-size:13px;
  color:#0f4c81;
}

.legend-group{
  margin-bottom:8px;
}

/* DOT SYMBOLS */
.dot{
  width:10px;
  height:10px;
  display:inline-block;
  border-radius:50%;
  margin-right:6px;
}
.social{background:#2563eb}
.transport{background:#f97316}
.nrm{background:#16a34a}
.water{background:#0ea5e9}
.energy{background:#eab308}
.economic{background:#7c3aed}

/* ===== EXISTING ASSETS MARKER ICONS IN LEGEND ===== */

.legend-marker{
  width:18px;
  height:18px;
  display:inline-block;
  margin-right:6px;
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
  vertical-align:middle;
}

/* üîµ WORKING */
.working-marker{
  background-image:url('https://img.icons8.com/ios-filled/50/2563eb/marker.png');
}

/* üî¥ NOT WORKING */
.notworking-marker{
  background-image:url('https://img.icons8.com/ios-filled/50/ef4444/marker.png');
}



/* LINE SYMBOLS */
.line{
  width:18px;
  height:3px;
  display:inline-block;
  margin-right:6px;
}
.bt{background:#7c3aed}
.cc{background:#22c55e}
.drain{background:#0284c7}
.boundary{background:#5b3a0e}

/* MAP CONTAINER */
#map-container{
  position: relative;
  width: 100%;
  height: 100%;
}

/* MAP */
#map{
  width: 100%;
  height: 100%;
}

/* ===== MAP LEGEND (FLOATING, COLLAPSIBLE) ===== */

#mapLegend{
  position:absolute;              /* üî• NOT fixed */
  bottom:20px;
  right:20px;
  width:240px;
  background:#ffffff;
  border-radius:8px;
  box-shadow:0 6px 18px rgba(0,0,0,0.25);
  font-size:12px;
  z-index:9999;
  overflow:hidden;
  pointer-events:auto;
}

/* header */
.legend-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 10px;
  background:#0f172a;
  color:#ffffff;
  font-weight:600;
}

/* toggle button */
.legend-header button{
  background:#ffffff;
  color:#0f172a;
  border:none;
  width:22px;
  height:22px;
  border-radius:4px;
  cursor:pointer;
  font-size:16px;
  line-height:1;
}

/* legend content */
.legend-group{
  padding:8px 10px;
  border-bottom:1px solid #e5e7eb;
}

/* collapsed state */
#mapLegend.collapsed .legend-group{
  display:none;
}

@media (max-width: 900px) {
  .map-widgets {
    display: none !important;
  }
}

@media (max-width: 900px) {
  #mapLegend {
    bottom: 80px;     /* above browser bar */
    right: 10px;
    width: 200px;
    font-size: 11px;
  }
}
.exec-text{
  text-align: justify;
  font-size: 11.5px;
  line-height: 1.45;
}
.exec-text b{
  font-weight: 600;
}
/* üî• FORCE NUMBER HIGHLIGHT ‚Äì FINAL OVERRIDE */
.executive-summary .exec-text b {
  font-weight: 800 !important;
  color: #fde047 !important;   /* visible yellow */
}
.mobile-only {
  display: none;
}

@media (max-width: 900px) {
  .mobile-only {
    display: block;
  }
}
@media (max-width: 900px) {
  #mobileDashBtn {
    display: flex !important;
    z-index: 99999 !important;
  }
}
#mobileDashBtn{
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 99999;   /* üî• ABOVE EVERYTHING */
}


</style>
</head>

<body>
<div id="mobileDashBtn">üìä</div>

<header class="app-header">
  <img src="https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/NMDCLOGO.png">
  <span>NMDC Samalwar ‚Äì Proposed Model Village Planning Dashboard</span>
</header>

<div class="main">
<div id="map-container">
  <div id="map"></div>

  <!-- MAP LEGEND -->
  <div id="mapLegend" class="collapsed">
    <div class="legend-header">
      <span>Legend</span>
      <button id="legendToggle" onclick="toggleLegend()">+</button>
    </div>

    <div class="legend-group">
      <b>Proposed Assets</b>
      <div><span class="dot social"></span> Social Infrastructure</div>
      <div><span class="dot transport"></span> Transport Infrastructure</div>
      <div><span class="dot nrm"></span> Natural Resource Management</div>
      <div><span class="dot water"></span> Drinking Water</div>
      <div><span class="dot energy"></span> Energy & Lighting</div>
      <div><span class="dot economic"></span> Economic Infrastructure</div>
    </div>

<div class="legend-group">
  <b>Existing Assets</b>
  <div>
    <span class="legend-marker working-marker"></span>
    Working
  </div>
  <div>
    <span class="legend-marker notworking-marker"></span>
    Not Working
  </div>
</div>


    <div class="legend-group">
      <b>Linear Assets</b>
      <div><span class="line bt"></span> BT Road</div>
      <div><span class="line cc"></span> CC Road</div>
      <div><span class="line drain"></span> Drain</div>
    </div>

    <div class="legend-group">
      <b>Boundary</b>
      <div><span class="line boundary"></span> Village Boundary</div>
    </div>
  </div>
</div>


<div class="map-widgets">

  <div class="map-widget">
    <h4>Infrastructure Distribution</h4>
    <canvas id="assetChart"></canvas>
  </div>

  <div class="map-widget">
    <h4>Road Network (BT / CC)</h4>
    <canvas id="roadChart"></canvas>
  </div>

</div>

  <div class="dashboard">
  
  <div class="chart-box executive-summary">
<h4>Executive Summary</h4>

<p class="exec-text">
  <b>128</b> development assets are proposed under an integrated village
  development plan for Samalwar, covering NRM interventions for agriculture,
  road connectivity, drinking water, social, energy, and economic infrastructure.
</p>

<p class="exec-text">
  The plan aims to strengthen livelihoods, improve basic services, enhance
  connectivity, and ensure environmental sustainability through coordinated
  infrastructure interventions aligned with NMDC‚Äôs CSR objectives, benefiting
  approximately <b>1,220</b> people across <b>330</b> households.
</p>
</div>


    <div class="kpis">
<div class="kpi"><span>Proposed Assets</span><h2 id="kpiAssets">‚Äì</h2></div>
<div class="kpi">  <span>Proposed BT Road Length (km)</span><h2 id="kpiBT">‚Äì</h2></div>
<div class="kpi">  <span>Proposed CC Road Length (km)</span><h2 id="kpiCC">‚Äì</h2></div>
<div class="kpi"><span>Proposed Asset Categories</span><h2 id="kpiTypes">‚Äì</h2></div>
    </div>
	
	<div class="chart-box">
  <h4>Infrastructure Categories</h4>

  <div id="categoryButtons" style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">
<button data-category="Social Infrastructure"
        onclick="toggleCategory('Social Infrastructure')">Social</button>

<button data-category="Transport Infrastructure"
        onclick="toggleCategory('Transport Infrastructure')">Transport</button>

<button data-category="Natural Resource Management"
        onclick="toggleCategory('Natural Resource Management')">NRM</button>

<button data-category="Drinking Water Infrastructure"
        onclick="toggleCategory('Drinking Water Infrastructure')">Drinking Water</button>

<button data-category="Energy & Lighting"
        onclick="toggleCategory('Energy & Lighting')">Energy</button>

<button data-category="Economic Infrastructure"
        onclick="toggleCategory('Economic Infrastructure')">Economic</button>

<button class="road-btn" onclick="toggleRoad('BT', this)">BT Roads</button>
<button class="road-btn" onclick="toggleRoad('CC', this)">CC Roads</button>



		<button onclick="resetAllFilters()"
        style="margin-bottom:6px;padding:6px;border:none;border-radius:6px;
               background:#ef4444;color:#fff;font-size:12px;font-weight:600;">
  Reset All
</button>
<button onclick="exportTable()"
        style="margin-bottom:6px;padding:6px;border:none;border-radius:6px;
               background:#16a34a;color:#fff;font-size:12px;font-weight:600;">
  Export CSV
</button>


  </div>
</div>
<div class="chart-box">
  <h4>Asset List</h4>
  <div style="max-height:220px;overflow:auto;">
    <table border="1" width="100%" cellpadding="4" style="font-size:11px;border-collapse:collapse;">
      <thead style="background:#f1f5f9;">
        <tr>
    <th>Sl. No</th>
    <th>Asset Name</th>
    <th>Type</th>
    <th>Category</th>
        </tr>
      </thead>
      <tbody id="assetTableBody"></tbody>
    </table>
  </div>
</div>
<!-- MOBILE CHARTS -->
<div class="chart-box mobile-only">
  <h4>Infrastructure Distribution</h4>
  <canvas id="assetChartMobile"></canvas>
</div>

<div class="chart-box mobile-only">
  <h4>Road Network (BT / CC)</h4>
  <canvas id="roadChartMobile"></canvas>
</div>




<div id="hamburger">‚ò∞</div>




<!-- FULL LAYER CONTROL -->
<div id="layerPanel">
<b>Basemap</b>

<label>
  <input type="checkbox" onchange="toggleSatellite(this)"> Satellite</label>

<label>
  <input type="checkbox" onchange="toggleAllDroneImages(this)">
  Drone Images
</label>






  <hr>
  <b>Layers</b>
  <label><input type="checkbox" checked onchange="toggle('boundary',this)"> Village Boundary</label>
  <label><input type="checkbox" checked onchange="toggle('points',this)"> Proposed Assets</label>
<label>
  <input type="checkbox" checked onchange="toggle('roads-bt',this)">
  Proposed BT Roads
</label>

<label>
  <input type="checkbox" checked onchange="toggle('roads-cc',this)">
  Proposed CC Roads
</label>
<label>
  <input type="checkbox" checked onchange="toggle('wall-3d',this)">
  Boundary Wall (3D)
</label>



  <label><input type="checkbox" onchange="toggle('drain',this)"> Natural Drainage Network</label>
  <label><input type="checkbox" checked onchange="toggle('para',this)"> Habitation / Para</label>
<label>
 <label>
  <input type="checkbox" onchange="toggleExistingAssets(this)">
  Existing Assets
</label>




</div>

<script>
const ALL_MAP_LAYERS = {
  assets: ['points', 'asset-labels'],
  roads: ['roads-bt', 'roads-cc'],
  drain: ['drain'],
  wall: ['wall-3d'],
  boundary: ['boundary'],
  para: ['para']
};


// CATEGORY MAPPING (MUST BE GLOBAL)
const infraCategoryMap = {

  "ANGANWADI BUILDING": "Social Infrastructure",
  "HANDWASHING PLATFORM": "Social Infrastructure",
"MULTILINGUAL AIDS": "Social Infrastructure",
"TOILET REFURBISHING": "Social Infrastructure",
  "COMMUNITY HALL": "Social Infrastructure",
  "MANDAP": "Social Infrastructure",
  "DOME SHED": "Social Infrastructure",
  "TOILETS": "Social Infrastructure",

  "BRIDGE": "Transport Infrastructure",
  "CULVERT": "Transport Infrastructure",

  "CHECKDAM": "Natural Resource Management",
  "POND RENNOVATION": "Natural Resource Management",
  "WHS": "Natural Resource Management",
  "LBCD": "Natural Resource Management",

  "SOLAR WATERTANK": "Drinking Water Infrastructure",

  "STREETLIGHTS": "Energy & Lighting",
  "HIGH MUST LIGHT": "Energy & Lighting",

  "MARKET COMPLEX": "Economic Infrastructure"
};
const ALL_INFRA_CATEGORIES = [
  "Social Infrastructure",
  "Transport Infrastructure",
  "Natural Resource Management",
  "Drinking Water Infrastructure",
  "Energy & Lighting",
  "Economic Infrastructure"
];

let infraChart = null;
let allAssetsData = null;
let activeCategory = null;
let allRoadsData = null;
let currentTableData = [];
let assetsLoaded = false;
let roadsLoaded = false;
let activeRoadType = null; // 'BT' | 'CC' | null
let mobileInfraChart = null;


const CATEGORY_ASSET_MAP = {
  "Social Infrastructure": [
    "ANGANWADI BUILDING",
    "HANDWASHING PLATFORM",
    "MULTILINGUAL AIDS",
    "TOILET REFURBISHING",
    "COMMUNITY HALL",
    "MANDAP",
    "DOME SHED",
    "TOILETS"
  ],
  "Transport Infrastructure": [
    "BRIDGE",
    "CULVERT"
  ],
  "Natural Resource Management": [
    "CHECKDAM",
    "POND RENNOVATION",
    "WHS",
    "LBCD"
  ],
  "Drinking Water Infrastructure": [
    "SOLAR WATERTANK"
  ],
  "Energy & Lighting": [
    "STREETLIGHTS",
    "HIGH MUST LIGHT"
  ],
  "Economic Infrastructure": [
    "MARKET COMPLEX"
  ]
};



function updateDonut(features){

  if (!infraChart) return; // üî• IMPORTANT

  const counts = buildInfraCategoryCounts(features);

  infraChart.data.datasets[0].data =
    ALL_INFRA_CATEGORIES.map(c => counts[c]);

  infraChart.update();
}



function setLayersVisibility(layerIds, visible){
  layerIds.forEach(id=>{
    if(map.getLayer(id)){
      map.setLayoutProperty(id,'visibility', visible ? 'visible' : 'none');
    }
  });
}

function clearSelection() {

  // Clear highlight
  if (map.getSource('feature-highlight')) {
    map.getSource('feature-highlight').setData({
      type: 'FeatureCollection',
      features: []
    });
  }

  // Remove popup if any
  document.querySelectorAll('.maplibregl-popup')
    .forEach(p => p.remove());
}


document.addEventListener('keydown', (e) => {

  // ESC key
  if (e.key === 'Escape') {
    clearSelection();
  }

});


function clearAllMapFilters(){
  if(map.getLayer('points')) map.setFilter('points', null);
  if(map.getLayer('asset-labels')) map.setFilter('asset-labels', null);
  if(map.getLayer('roads-bt')) map.setFilter('roads-bt', ['==', ['get','LAYER'], 'BT ROAD']);
  if(map.getLayer('roads-cc')) map.setFilter('roads-cc', ['==', ['get','LAYER'], 'CC ROAD']);
}


function hideAllLayers(){
  Object.values(ALL_MAP_LAYERS).flat()
    .forEach(id=>{
      if(map.getLayer(id)){
        map.setLayoutProperty(id,'visibility','none');
      }
    });
}


function focusMode({ layers=[], tableData=[] }){

  // üî• CRITICAL FIX
  clearAllMapFilters();

  // 1Ô∏è‚É£ Hide everything
  Object.values(ALL_MAP_LAYERS).flat().forEach(id=>{
    if(map.getLayer(id)){
      map.setLayoutProperty(id,'visibility','none');
    }
  });

  // 2Ô∏è‚É£ Show only requested layers
  layers.forEach(group=>{
    ALL_MAP_LAYERS[group].forEach(id=>{
      if(map.getLayer(id)){
        map.setLayoutProperty(id,'visibility','visible');
      }
    });
  });

  // 3Ô∏è‚É£ Clear highlight
  map.getSource('feature-highlight').setData({
    type:'FeatureCollection',
    features:[]
  });

  // 4Ô∏è‚É£ Update table
  renderTable(tableData);

  // 5Ô∏è‚É£ Update KPIs
  updateKPIs(tableData);
}





function getDefaultTableData(){
  const points = allAssetsData ? allAssetsData.features : [];
  const roads  = allRoadsData  ? allRoadsData.features  : [];
  return [...points, ...roads];
}


function activateRoadBtn(btn){

  const isActive = btn.classList.contains('active');

  document
    .querySelectorAll('#categoryButtons button')
    .forEach(b => b.classList.remove('active'));

  if (!isActive) {
    btn.classList.add('active');
  }
}

function highlightCleanFeature(feature){
  map.getSource('feature-highlight').setData({
    type: 'FeatureCollection',
    features: [feature]
  });
}


function setActiveButton(category){
  document.querySelectorAll('#categoryButtons button')
    .forEach(btn=>{
      btn.classList.remove('active');
      if(category && btn.dataset.category === category){
        btn.classList.add('active');
      }
    });
}

function renderTable(features){
  const tbody = document.getElementById('assetTableBody');
  tbody.innerHTML = '';
  currentTableData = features;

features.forEach((f, index)=>{
    const tr = document.createElement('tr');
    tr.style.cursor='pointer';

    const isLine = f.geometry.type !== 'Point';
	

tr.innerHTML = `
  <td>${index + 1}</td>
  <td>${f.properties.NAME || '‚Äî'}</td>
  <td>${f.properties.LAYER || '‚Äî'}</td>
  <td>${infraCategoryMap[f.properties.LAYER] || '‚Äî'}</td>
`;


tr.onclick = () => {

  // üî• CLEAR OLD HIGHLIGHT
  map.getSource('feature-highlight').setData({
    type: 'FeatureCollection',
    features: []
  });

  if (f.geometry.type === 'Point') {

    map.flyTo({
      center: f.geometry.coordinates,
      zoom: 17,
      speed: 0.8
    });

  } else {

    map.fitBounds(turf.bbox(f), {
      padding: 50,
      duration: 800
    });

  }

  // üî• HIGHLIGHT (POINT OR LINE)
  highlightCleanFeature(f);
};


    tbody.appendChild(tr);
  });
}


function renderRoadTable(features){
  const tbody = document.getElementById('assetTableBody');
  tbody.innerHTML = '';
  currentTableData = features;


  features.forEach((f, index)=>{
    const lenKm = f.properties.Shape_Leng
      ? (f.properties.Shape_Leng / 1000).toFixed(2)
      : '-';

    const tr = document.createElement('tr');
    tr.style.cursor = 'pointer';

tr.innerHTML = `
  <td>${index + 1}</td>
  <td>${f.properties.NAME || 'Road'}</td>
  <td>${f.properties.LAYER}</td>
  <td>${lenKm} km</td>
`;


tr.onclick = () => {

  map.getSource('feature-highlight').setData({
    type: 'FeatureCollection',
    features: []
  });

  map.fitBounds(turf.bbox(f), {
    padding: 50,
    duration: 800
  });

  highlightCleanFeature(f);
};

    tbody.appendChild(tr);
  });
}

function zoomToFullExtent(){

  let bounds = null;

  // Assets (points)
  if (allAssetsData && allAssetsData.features.length) {
    bounds = turf.bbox(allAssetsData);
  }

  // Roads
  if (allRoadsData && allRoadsData.features.length) {
    const roadBounds = turf.bbox(allRoadsData);
    bounds = bounds
      ? turf.bboxPolygon([
          Math.min(bounds[0], roadBounds[0]),
          Math.min(bounds[1], roadBounds[1]),
          Math.max(bounds[2], roadBounds[2]),
          Math.max(bounds[3], roadBounds[3])
        ]).bbox
      : roadBounds;
  }

  // Safety check
  if (!bounds) return;

  map.fitBounds(bounds, {
    padding: 60,
    duration: 1000
  });
}

function resetAllFilters(){

  // Clear filters
  map.setFilter('points', null);
  map.setFilter('asset-labels', null);

  // Show all layers
  [
    'points','asset-labels',
    'roads-bt','roads-cc',
    'drain','wall-3d'
  ].forEach(id=>{
    if(map.getLayer(id)){
      map.setLayoutProperty(id,'visibility','visible');
    }
  });

  // Reset table + KPIs
  renderTable(getDefaultTableData());
  updateKPIs(allAssetsData.features);

  // üî• THIS IS THE KEY
  resetDonut();

  // Clear buttons
  document.querySelectorAll('#categoryButtons button')
    .forEach(b => b.classList.remove('active'));

  zoomToFullExtent();
}






function hideAllMapLayers(){

  const allLayers = [
    'points','asset-labels',
    'roads-bt','roads-cc',
    'drain','wall-3d'
  ];

  allLayers.forEach(id=>{
    if(map.getLayer(id)){
      map.setLayoutProperty(id,'visibility','none');
    }
  });
}


function updateKPIs(features){

  let assetCount = 0;
  let categories = new Set();

  features.forEach(f=>{
    if (f.geometry.type === 'Point') {
      assetCount++;
      const cat = infraCategoryMap[f.properties.LAYER];
      if (cat) categories.add(cat);
    }
  });

  kpiAssets.innerText = assetCount;
  kpiTypes.innerText = categories.size;
}


function exportTable(){

  if (!currentTableData.length) {
    alert('No data to export');
    return;
  }

  let csv = "Name,Type,Extra\n";

  currentTableData.forEach(f=>{
    csv += `"${f.properties.NAME || ''}",` +
           `"${f.properties.LAYER || ''}",` +
           `"${f.properties.Shape_Leng ? (f.properties.Shape_Leng/1000).toFixed(2)+' km' : ''}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');

  link.href = URL.createObjectURL(blob);
  link.download = "Samalwar_Table_Export.csv";
  link.click();
}

function toggleExistingAssets(cb){

  const visibility = cb.checked ? 'visible' : 'none';

  // ICON layer
  if (map.getLayer('existing-assets-icon')) {
    map.setLayoutProperty(
      'existing-assets-icon',
      'visibility',
      visibility
    );
  }

  // LABEL layer
  if (map.getLayer('existing-assets-label')) {
    map.setLayoutProperty(
      'existing-assets-label',
      'visibility',
      visibility
    );
  }
}


function toggleRoad(type, btn){

  // 1Ô∏è‚É£ HIDE EVERYTHING
  hideAllMapLayers();

  // 2Ô∏è‚É£ SHOW ONLY ONE ROAD
  const layerId = type === 'BT' ? 'roads-bt' : 'roads-cc';
  map.setLayoutProperty(layerId,'visibility','visible');

  // 3Ô∏è‚É£ TABLE
  const filtered = allRoadsData.features.filter(
    f => f.properties.LAYER === (type === 'BT' ? 'BT ROAD' : 'CC ROAD')
  );
  renderRoadTable(filtered);

  // 4Ô∏è‚É£ KPIs (roads don‚Äôt affect asset KPIs)
  updateKPIs([]);

  // 5Ô∏è‚É£ BUTTON UI
  document.querySelectorAll('#categoryButtons button')
    .forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}





function syncRoadCheckboxes(btVisible, ccVisible) {
  const checkboxes = document.querySelectorAll('#layerPanel input[type="checkbox"]');

  checkboxes.forEach(cb => {
    if (cb.getAttribute('onchange')?.includes('roads-bt')) {
      cb.checked = btVisible;
    }
    if (cb.getAttribute('onchange')?.includes('roads-cc')) {
      cb.checked = ccVisible;
    }
  });
}

function buildInfraCategoryCounts(features){

  let counts = {};
  ALL_INFRA_CATEGORIES.forEach(c => counts[c] = 0);

  features.forEach(f => {
    const cat = infraCategoryMap[f.properties.LAYER];
    if (cat) counts[cat]++;
  });

  return counts;
}




// ================= GLOBAL TOGGLE FUNCTIONS =================

function toggle(id, cb){
  if (!map || !map.getLayer(id)) {
    console.warn('Layer not found:', id);
    return;
  }
  map.setLayoutProperty(
    id,
    'visibility',
    cb.checked ? 'visible' : 'none'
  );
}

function toggleAllDroneImages(cb){
  if (!map) return;
  const visibility = cb.checked ? 'visible' : 'none';

  ['custom-tiles','custom-tiles-2','custom-tiles-3']
    .forEach(id=>{
      if(map.getLayer(id)){
        map.setLayoutProperty(id,'visibility',visibility);
      }
    });
}

function toggleSatellite(cb){
  if (!map || !map.getLayer('satellite')) return;
  map.setLayoutProperty(
    'satellite',
    'visibility',
    cb.checked ? 'visible' : 'none'
  );
}




const map=new maplibregl.Map({
 container:'map',
 style:'https://api.maptiler.com/maps/streets-v4/style.json?key=CrM6DtW2lDzoc91uhUpc',
 center:[ 81.312614, 18.606753],
  zoom: 18,               // üëà close village view
  pitch: 60,                // üëà 3D angle
  bearing: -25,             // üëà same oblique feel
  duration: 0               // üëà instant (no animation)
});
map.addControl(new maplibregl.NavigationControl());

hamburger.onclick=()=>layerPanel.style.display=
 layerPanel.style.display==='block'?'none':'block';

map.on('load', () => {

  // üî¥ HIGHLIGHT SOURCE (ONE TIME)
  map.addSource('feature-highlight', {
    type: 'geojson',
    data: {
      type: 'FeatureCollection',
      features: []
    }
  });

  // üî¥ POINT HIGHLIGHT
  map.addLayer({
    id: 'feature-highlight-point',
    type: 'circle',
    source: 'feature-highlight',
    filter: ['==', '$type', 'Point'],
    paint: {
      'circle-radius': 12,
      'circle-color': '#ff0000',
      'circle-opacity': 0.6,
      'circle-stroke-color': '#ffffff',
      'circle-stroke-width': 3
    }
  });

  // üî¥ LINE HIGHLIGHT
  map.addLayer({
    id: 'feature-highlight-line',
    type: 'line',
    source: 'feature-highlight',
    filter: ['==', '$type', 'LineString'],
    paint: {
      'line-color': '#ff0000',
      'line-width': 10
    }
  });



/* SATELLITE */
map.addSource('satellite',{
 type:'raster',
 tiles:['https://api.maptiler.com/maps/streets-v4/style.json?key=CrM6DtW2lDzoc91uhUpc'],
 tileSize:256
});
map.addLayer({
 id:'satellite',
 type:'raster',
 source:'satellite',
 layout:{visibility:'none'}
});

/* CUSTOM MAPTILER TILESET */
map.addSource('custom-tiles', {
  type: 'raster',
  tiles: [
    'https://api.maptiler.com/tiles/019bdfd4-0367-7856-b471-411354ec9456/{z}/{x}/{y}.webp?key=IIOg8XrNVRxxY7Q8FZq9'
  ],
  tileSize: 256
});

map.addLayer({
  id: 'custom-tiles',
  type: 'raster',
  source: 'custom-tiles',
   minzoom: 15,
  layout: {
    visibility: 'none'   // IMPORTANT: starts OFF
  }
});

/* CUSTOM MAPTILER TILESET ‚Äì 2 */
map.addSource('custom-tiles-2', {
  type: 'raster',
  tiles: [
    'https://api.maptiler.com/tiles/019be00b-1035-7f33-8e71-17a439354ddc/{z}/{x}/{y}.webp?key=ImWmkzmSRgV6JxtUNT4L'
  ],
  tileSize: 256
});

map.addLayer({
  id: 'custom-tiles-2',
  type: 'raster',
  source: 'custom-tiles-2',
   minzoom: 15,
  layout: {
    visibility: 'none'   // OFF by default
  }
});

/* CUSTOM MAPTILER TILESET ‚Äì 3 */
map.addSource('custom-tiles-3', {
  type: 'raster',
  tiles: [
    'https://api.maptiler.com/tiles/019be01f-0291-7f9e-a4ac-b6643e91a5aa/{z}/{x}/{y}.webp?key=C8Txr9n6hdQqTYvqjBMn'
  ],
  tileSize: 256
});

map.addLayer({
  id: 'custom-tiles-3',
  type: 'raster',
  source: 'custom-tiles-3',
   minzoom: 15,
  layout: {
    visibility: 'none'
  }
});


/* VILLAGE BOUNDARY */
map.addSource('boundary',{
 type:'geojson',
 data:'https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_vbs.geojson'
});
map.addLayer({
 id:'boundary',
 type:'line',
 source:'boundary',
 paint:{'line-color':'#5b3a0e','line-width':10}
});

/* PARA (HOME SYMBOL) */
map.loadImage(
 'https://img.icons8.com/ios-filled/50/0f4c81/home.png',
 (e,img)=>{
  map.addImage('home',img);
  map.addSource('para',{
    type:'geojson',
    data:'https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Location_Name.geojson'
  });
  map.addLayer({
    id:'para',
    type:'symbol',
    source:'para',
    layout:{
      'icon-image':'home',
      'icon-size':0.8,
      'text-field':['get','LAYER'],
      'text-size':14,
      'text-offset':[0,1.5],
      'text-font':['Open Sans Bold']
    },
    paint:{
      'text-color':'#0f4c81',
      'text-halo-color':'#fff',
      'text-halo-width':2
    }
  });
  });
  
// üîµ WORKING ICON
map.loadImage(
  'https://img.icons8.com/ios-filled/50/2563eb/marker.png',
  (error, image) => {
    if (error) throw error;
    if (!map.hasImage('existing-working')) {
      map.addImage('existing-working', image);
    }
  }
);

// üî¥ NOT WORKING ICON
map.loadImage(
  'https://img.icons8.com/ios-filled/50/ef4444/marker.png',
  (error, image) => {
    if (error) throw error;
    if (!map.hasImage('existing-not-working')) {
      map.addImage('existing-not-working', image);
    }
  }
);

function createHandPumpIcon(colorPipe) {
  const size = 64;
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');

  // Platform
  ctx.fillStyle = '#9ca3af';
  ctx.beginPath();
  ctx.ellipse(32, 54, 22, 6, 0, 0, Math.PI * 2);
  ctx.fill();

  // Vertical pipe
  ctx.fillStyle = colorPipe;
  ctx.fillRect(30, 20, 4, 30);

  // Pump head
  ctx.fillStyle = colorPipe;
  ctx.fillRect(25, 16, 14, 6);

  // Pivot
  ctx.beginPath();
  ctx.arc(26, 18, 2, 0, Math.PI * 2);
  ctx.fill();

  // Handle (LEFT)
  ctx.save();
  ctx.translate(26, 18);
  ctx.rotate(18 * Math.PI / 180);
  ctx.fillRect(-24, -1.5, 24, 3);
  ctx.restore();

  // Water outlet (RIGHT)
  ctx.save();
  ctx.translate(34, 24);
  ctx.rotate(10 * Math.PI / 180);
  ctx.fillRect(0, 0, 12, 3);
  ctx.restore();

  // Water drop
  ctx.fillStyle = '#0ea5e9';
  ctx.beginPath();
  ctx.moveTo(46, 28);
  ctx.bezierCurveTo(43, 32, 43, 36, 46, 38);
  ctx.bezierCurveTo(49, 36, 49, 32, 46, 28);
  ctx.fill();

  return ctx.getImageData(0, 0, size, size);
}

// ‚úÖ WORKING = GREY
map.addImage(
  'hand-pump-working',
  createHandPumpIcon('#6b7280')
);

// ‚ùå NOT WORKING = RED
map.addImage(
  'hand-pump-not-working',
  createHandPumpIcon('#dc2626')
);


function createSolarTankIcon() {
  const size = 64;
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');

  // Solar panel
  ctx.fillStyle = '#eab308';
  ctx.fillRect(22, 2, 20, 8);
  ctx.strokeStyle = '#78350f';
  ctx.beginPath();
  ctx.moveTo(22, 6);
  ctx.lineTo(42, 6);
  ctx.stroke();

  // Tank top
  ctx.fillStyle = '#0ea5e9';
  ctx.beginPath();
  ctx.ellipse(32, 16, 10, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Tank body
  ctx.fillStyle = '#38bdf8';
  ctx.fillRect(22, 16, 20, 12);

  // Tank bottom
  ctx.fillStyle = '#0284c7';
  ctx.beginPath();
  ctx.ellipse(32, 28, 10, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Tower legs
  ctx.fillStyle = '#64748b';
  ctx.fillRect(20, 28, 4, 26);
  ctx.fillRect(40, 28, 4, 26);

  // Cross braces
  ctx.strokeStyle = '#475569';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(20, 32);
  ctx.lineTo(44, 48);
  ctx.moveTo(44, 32);
  ctx.lineTo(20, 48);
  ctx.stroke();

  // Base
  ctx.fillStyle = '#6b7280';
  ctx.fillRect(16, 54, 32, 4);

  return ctx.getImageData(0, 0, size, size);
}

map.addImage('solar-tank-icon', createSolarTankIcon());



map.addSource('existing-assets', {
  type: 'geojson',
  data: 'https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Existing_Assets.geojson'
});

map.addLayer({
  id: 'existing-assets-icon',
  type: 'symbol',
  source: 'existing-assets',
  layout: {
    visibility: 'none',

    'icon-image': [
      'case',

      // üîÜ SOLAR WATER TANK
      ['in', 'SOLAR', ['upcase', ['get', 'DESCRIPTIO']]],
      'solar-tank-icon',

      // ‚ùå NOT WORKING HAND PUMP / TUBE WELL
      [
        'all',
        ['in', 'TUBE', ['upcase', ['get', 'DESCRIPTIO']]],
        ['in', 'NOT', ['upcase', ['get', 'DESCRIPTIO']]]
      ],
      'hand-pump-not-working',

      // ‚úÖ WORKING HAND PUMP / TUBE WELL
      ['in', 'TUBE', ['upcase', ['get', 'DESCRIPTIO']]],
      'hand-pump-working',

      // fallback
      'existing-working'
    ],

    'icon-size': 0.8,
    'icon-allow-overlap': true,
    'icon-ignore-placement': true
  }
});





map.addLayer({
  id: 'existing-assets-label',
  type: 'symbol',
  source: 'existing-assets',
  minzoom: 15,
  layout: {
    visibility: 'none',
    'text-field': ['get', 'DESCRIPTIO'],
    'text-size': 11,
    'text-offset': [0, 1.6],
    'text-anchor': 'top'
  },
  paint: {
    'text-color': '#0f172a',
    'text-halo-color': '#ffffff',
    'text-halo-width': 2
  }
});





/* ===============================
   EXISTING ASSETS ‚Äì CLICK POPUP
   =============================== */

// üî• Click on ICON layer
map.on('click', 'existing-assets-icon', (e) => {

  const f = e.features[0];
  const desc = f.properties.DESCRIPTIO;

  const status = desc.toUpperCase().includes('NOT WORKING')
    ? '‚ùå Not Working'
    : '‚úÖ Working';

  new maplibregl.Popup({ offset: 10 })
    .setLngLat(f.geometry.coordinates)
    .setHTML(`
      <div style="font-size:13px;">
        <b>Existing Asset</b><br/>
        ${desc}<br/>
        <b>Status:</b> ${status}
      </div>
    `)
    .addTo(map);
});

// üî• Click on LABEL layer (important)
map.on('click', 'existing-assets-label', (e) => {

  const f = e.features[0];
  const desc = f.properties.DESCRIPTIO;

  const status = desc.toUpperCase().includes('NOT WORKING')
    ? '‚ùå Not Working'
    : '‚úÖ Working';

  new maplibregl.Popup({ offset: 10 })
    .setLngLat(f.geometry.coordinates)
    .setHTML(`
      <div style="font-size:13px;">
        <b>Existing Asset</b><br/>
        ${desc}<br/>
        <b>Status:</b> ${status}
      </div>
    `)
    .addTo(map);
});

/* ===============================
   CURSOR CHANGE (ICON + LABEL)
   =============================== */

['existing-assets-icon', 'existing-assets-label'].forEach(layer => {

  map.on('mouseenter', layer, () => {
    map.getCanvas().style.cursor = 'pointer';
  });

  map.on('mouseleave', layer, () => {
    map.getCanvas().style.cursor = '';
  });

});



/* PROPOSED ASSETS ‚Äì COLORED AS PER ACTUAL LAYER VALUES */
map.addSource('points',{
  type:'geojson',
  data:'https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Points.geojson'
});

map.addLayer({
  id: 'points',
  type: 'circle',
  source: 'points',
  paint: {

    'circle-radius': 6,
    'circle-stroke-color': '#ffffff',
    'circle-stroke-width': 1.2,

    // üî• CATEGORY-BASED COLORING
    'circle-color': [
      'case',

      // üü¶ Social Infrastructure
      ['in', ['get', 'LAYER'], ['literal', [
        'ANGANWADI BUILDING',
        'HANDWASHING PLATFORM',
        'MULTILINGUAL AIDS',
        'TOILET REFURBISHING',
        'COMMUNITY HALL',
        'MANDAP',
        'DOME SHED',
        'TOILETS'
      ]]],
      '#2563eb',

      // üüß Transport Infrastructure
      ['in', ['get', 'LAYER'], ['literal', [
        'BRIDGE',
        'CULVERT'
      ]]],
      '#f97316',

      // üü© Natural Resource Management
      ['in', ['get', 'LAYER'], ['literal', [
        'CHECKDAM',
        'POND RENNOVATION',
        'WHS',
        'LBCD'
      ]]],
      '#16a34a',

      // üü¶ Drinking Water Infrastructure
      ['in', ['get', 'LAYER'], ['literal', [
        'SOLAR WATERTANK'
      ]]],
      '#0ea5e9',

      // üü® Energy & Lighting
      ['in', ['get', 'LAYER'], ['literal', [
        'STREETLIGHTS',
        'HIGH MUST LIGHT'
      ]]],
      '#eab308',

      // üü™ Economic Infrastructure
      ['in', ['get', 'LAYER'], ['literal', [
        'MARKET COMPLEX'
      ]]],
      '#7c3aed',

      // üîò Default (fallback)
      '#64748b'
    ]
  }
});




map.on('sourcedata', (e) => {
  if (e.sourceId === 'points' && map.isSourceLoaded('points')) {
    const src = map.getSource('points');
    if (src && src._data && !allAssetsData) {
      allAssetsData = src._data;
      renderTable(getDefaultTableData());
    }
  }
});



map.addLayer({
  id:'asset-labels',
  type:'symbol',
  source:'points',
  layout:{
    'text-field':['get','LAYER'],
    'text-size':11,
    'text-offset':[0,1.4]
  },
  paint:{
    'text-color':'#111827',
    'text-halo-color':'#ffffff',
    'text-halo-width':2
  }
});


/* PROPOSED ROADS */
map.addSource('roads-src',{
 type:'geojson',
 data:'https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Lines.geojson'
});
/* BT ROADS */
map.addLayer({
  id: 'roads-bt',
  type: 'line',
  source: 'roads-src',
  filter: ['==', ['get', 'LAYER'], 'BT ROAD'],
  paint: {
    'line-color': '#7c3aed',
    'line-width': 5
  }
});

/* CC ROADS */
map.addLayer({
  id: 'roads-cc',
  type: 'line',
  source: 'roads-src',
  filter: ['==', ['get', 'LAYER'], 'CC ROAD'],
  paint: {
    'line-color': '#22c55e',
    'line-width': 4
  }
});

/* =======================
   3D BOUNDARY WALL (LINE ‚Üí POLYGON ‚Üí EXTRUSION)
   ======================= */

fetch('https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Lines.geojson')
  .then(r => r.json())
  .then(data => {

    // 1Ô∏è‚É£ Filter only boundary wall lines
    const wallLines = data.features.filter(
      f => f.properties.LAYER === 'BOUNDARY WALL'
    );

    // 2Ô∏è‚É£ Convert line ‚Üí thin polygon (0.3m thickness)
    const wallPolygons = wallLines.map(f =>
      turf.buffer(f, 0.15, { units: 'meters' })
    );

    // 3Ô∏è‚É£ Add polygon source
    map.addSource('wall-3d', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: wallPolygons
      }
    });

    // 4Ô∏è‚É£ Add 3D extrusion layer
    map.addLayer({
      id: 'wall-3d',
      type: 'fill-extrusion',
      source: 'wall-3d',
      minzoom: 15,
      paint: {
        'fill-extrusion-color': '#6b7280',
        'fill-extrusion-height': 2.5,   // üî• wall height (meters)
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.9
      }
    });
	
	map.addLayer({
  id: 'feature-highlight-wall',
  type: 'fill-extrusion',
  source: 'feature-highlight',
  filter: ['==', '$type', 'Polygon'],
  paint: {
    'fill-extrusion-color': '#ff0000',
    'fill-extrusion-height': 3,
    'fill-extrusion-base': 0,
    'fill-extrusion-opacity': 0.9
  }
});

	
	/* PROPOSED DRAIN */
map.addSource('drain-src',{
 type:'geojson',
 data:'https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Drainage_Lines.geojson'
});
map.addLayer({
 id:'drain',
 type:'line',
 source:'drain-src',
 layout: {
   visibility: 'none'   // üî• DEFAULT OFF
 },
 paint:{
   'line-color':'#0284c7',
   'line-width':2
 }
});


map.easeTo({
  pitch: 60,
  bearing: -20,
  duration: 1200
});
}); // ‚úÖ CLOSE map.on('load')


/* LOAD ASSET DATA FOR TABLE & FILTER (FILE:// SAFE) */
fetch('https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Points.geojson')
  .then(r => r.json())
  .then(data => {
    allAssetsData = data;
  assetsLoaded = true;
  if(roadsLoaded) renderTable(getDefaultTableData());
});


map.on('click', 'points', (e) => {
  const feature = e.features[0];

  highlightCleanFeature(feature);


  new maplibregl.Popup({ offset: 10 })
    .setLngLat(e.lngLat)
    .setHTML(`
      <div style="font-size:13px;">
        <b>Proposed Activity</b><br/>
        ${feature.properties.NAME || 'N/A'}
      </div>
    `)
    .addTo(map);
});
fetch('https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Lines.geojson')
  .then(r => r.json())
  .then(data => {
    allRoadsData = data;
  roadsLoaded = true;
  if(assetsLoaded) renderTable(getDefaultTableData());
});

// Change cursor on hover (roads)
['roads-bt','roads-cc','wall-3d'].forEach(layer=>{
  map.on('mouseenter', layer, ()=>map.getCanvas().style.cursor='pointer');
  map.on('mouseleave', layer, ()=>map.getCanvas().style.cursor='');
}); // ‚úÖ THIS WAS MISSING

// Change cursor on hover (point assets)
['points', 'asset-labels'].forEach(layer => {

  map.on('mouseenter', layer, () => {
    map.getCanvas().style.cursor = 'pointer';
  });

  map.on('mouseleave', layer, () => {
    map.getCanvas().style.cursor = '';
  });

});



window.toggleCategory = function(category){

  // 1Ô∏è‚É£ Hide everything
  hideAllMapLayers();

  // 2Ô∏è‚É£ Find asset types for this category
  const allowedTypes = Object.keys(infraCategoryMap)
    .filter(k => infraCategoryMap[k] === category);

  // 3Ô∏è‚É£ Apply MAP FILTER (IMPORTANT)
  const filterExpr = ['in', ['get','LAYER'], ['literal', allowedTypes]];

  map.setFilter('points', filterExpr);
  map.setFilter('asset-labels', filterExpr);

  // 4Ô∏è‚É£ Show asset points
  map.setLayoutProperty('points','visibility','visible');
  map.setLayoutProperty('asset-labels','visibility','visible');

  // üîµ SOCIAL ‚Üí SHOW BOUNDARY WALL
  if (category === 'Social Infrastructure') {
    if (map.getLayer('wall-3d')) {
      map.setLayoutProperty('wall-3d','visibility','visible');
    }
  }

  // üü¢ NRM ‚Üí SHOW DRAINAGE
  if (category === 'Natural Resource Management') {
    if (map.getLayer('drain')) {
      map.setLayoutProperty('drain','visibility','visible');
    }
  }

  // 5Ô∏è‚É£ TABLE (ONLY POINT ASSETS)
  const filtered = allAssetsData.features.filter(f =>
    allowedTypes.includes(f.properties.LAYER)
  );
  renderTable(filtered);

  // 6Ô∏è‚É£ KPIs
  updateKPIs(filtered);
  updateDonutByCategory(category, filtered);



  // 7Ô∏è‚É£ Button UI
  setActiveButton(category);
};




/* ===== CLICK HIGHLIGHT FOR ROADS & WALL (FINAL) ===== */

['roads-bt','roads-cc','wall-3d'].forEach(layer => {

  map.on('click', layer, (e) => {

    const feature = e.features[0];
    const props = feature.properties;

    map.getSource('feature-highlight').setData({
      type: 'FeatureCollection',
      features: [feature]
    });

    const lengthKm = props.Shape_Leng
      ? (props.Shape_Leng / 1000).toFixed(2)
      : 'N/A';

    new maplibregl.Popup({ offset: 10 })
      .setLngLat(e.lngLat)
      .setHTML(`
        <div style="font-size:13px;">
          <b>Proposed Road</b><br/>
          <b>Type:</b> ${props.LAYER}<br/>
          <b>Name:</b> ${props.NAME || 'N/A'}<br/>
          <b>Length:</b> ${lengthKm} km
        </div>
      `)
      .addTo(map);

  });

}); // ‚úÖ THIS LINE FIXES THE ERROR
















/* DASHBOARD DATA */
Promise.all([
 fetch('https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Points.geojson').then(r=>r.json()),
 fetch('https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Samalwar_Lines.geojson').then(r=>r.json()),
 fetch('https://raw.githubusercontent.com/hemanya2003/NMDC-Chattisgarh/main/Drainage_Lines.geojson').then(r=>r.json())
]).then(([p,r,d])=>{
 let assetCounts={},types=new Set(),assets=0,bt=0,cc=0,drainLen=0;

 p.features.forEach(f=>{
  assets++;
  types.add(f.properties.LAYER);
  assetCounts[f.properties.LAYER]=(assetCounts[f.properties.LAYER]||0)+1;
 });
 


 
 /* ===== PROPOSED INFRASTRUCTURE CATEGORY DISTRIBUTION ===== */


// INITIALIZE COUNTS
let infraCategoryCounts = {
  "Social Infrastructure": 0,
  "Transport Infrastructure": 0,
  "Natural Resource Management": 0,
  "Drinking Water Infrastructure": 0,
  "Energy & Lighting": 0,
  "Economic Infrastructure": 0
};

// COUNT POINT FEATURES INTO CATEGORIES
p.features.forEach(f => {
  const assetType = f.properties.LAYER;
  const category = infraCategoryMap[assetType];
  if (category) {
    infraCategoryCounts[category]++;
  }
});


 r.features.forEach(f=>{
  const len=f.properties.Shape_Leng/1000;
  if(f.properties.LAYER==='BT ROAD') bt+=len;
  if(f.properties.LAYER==='CC ROAD') cc+=len;
 });

 d.features.forEach(f=>drainLen+=f.properties.Shape_Leng/1000);

 kpiAssets.innerText=assets;
const usedCategories = Object.values(infraCategoryCounts)
  .filter(count => count > 0).length;

kpiTypes.innerText = usedCategories;

kpiBT.innerText = bt.toFixed(2);
kpiCC.innerText = cc.toFixed(2);



/* ===== FINAL DONUT WITH FULL LEGEND + CLICK PERCENT ===== */

const infraLabels = [
  "Social Infrastructure",
  "Transport Infrastructure",
  "Natural Resource Management",
  "Drinking Water Infrastructure",
  "Energy & Lighting",
  "Economic Infrastructure"
];

const infraValues = infraLabels.map(l => infraCategoryCounts[l] || 0);



/* =========================================================
   FINAL CHART INITIALIZATION BLOCK (COPY‚ÄìPASTE)
   ========================================================= */

// üî• MAKE infraChart GLOBAL (VERY IMPORTANT)
window.infraChart = null;

/* ---------- BUILD DONUT DATA ---------- */
function buildInfraCategoryCounts(features){
  let counts = {};
  ALL_INFRA_CATEGORIES.forEach(c => counts[c] = 0);

  features.forEach(f => {
    const cat = infraCategoryMap[f.properties.LAYER];
    if (cat) counts[cat]++;
  });

  return counts;
}

/* ---------- CREATE DONUT ONCE ---------- */
const initialCounts = buildInfraCategoryCounts(p.features);
const rawCounts = ALL_INFRA_CATEGORIES.map(c => initialCounts[c]);

infraChart = new Chart(
  document.getElementById('assetChart'),
  {
    type: 'doughnut',
    data: {
      labels: ALL_INFRA_CATEGORIES,
      datasets: [{
        data: rawCounts,
        backgroundColor: [
          '#2563eb',
          '#f97316',
          '#16a34a',
          '#0ea5e9',
          '#eab308',
          '#7c3aed'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '50%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {boxWidth: 10,
    padding: 6, 
            font: { size: 11, weight: '600' }
          }
        },
tooltip: {
  callbacks: {
    title: function (items) {
      const chart = items[0].chart;              // üî• CORRECT SOURCE
      const idx = items[0].dataIndex;
      return chart.data.labels[idx];             // ‚úÖ correct label
    },
    label: function (ctx) {
      const chart = ctx.chart;                   // üî• CORRECT SOURCE
      const idx = ctx.dataIndex;
      const value = chart.data.datasets[0].data[idx];
      return `Count: ${value}`;
    }
  }
},


        // ‚úÖ FINAL, STABLE COUNT DISPLAY
        datalabels: {
          color: '#ffffff',
          font: {
            weight: 'bold',
            size: 11
          },
          formatter: (value) => {
            return value > 0 ? value : '';
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  }
);

const mobileCounts = ALL_INFRA_CATEGORIES.map(c => initialCounts[c]);
createMobileDonut(mobileCounts);



/* ---------- UPDATE DONUT (CALLED FROM BUTTONS) ---------- */
/* ---------- UPDATE DONUT (CALLED FROM BUTTONS) ---------- */
window.updateDonutByCategory = function(category, features){

  if (!infraChart) return;

  const assetTypes = CATEGORY_ASSET_MAP[category];

  let counts = {};
  assetTypes.forEach(a => counts[a] = 0);

  features.forEach(f => {
    if (assetTypes.includes(f.properties.LAYER)) {
      counts[f.properties.LAYER]++;
    }
  });

  // üîÅ BUILD RAW COUNTS ARRAY (VERY IMPORTANT)
  const newRawCounts = assetTypes.map(a => counts[a]);

  // üîÅ UPDATE CHART
  infraChart.data.labels = assetTypes;
  infraChart.data.datasets[0].data = newRawCounts;

  // üî• THIS IS THE MISSING LINE
  infraChart.config.data.__rawCounts = newRawCounts;

  infraChart.update();
};



/* ---------- RESET DONUT (FULL DATA) ---------- */
window.resetDonut = function(){

  const rawCounts =
    ALL_INFRA_CATEGORIES.map(c => initialCounts[c]);

  infraChart.data.labels = ALL_INFRA_CATEGORIES;
  infraChart.data.datasets[0].data = rawCounts;

  // üî• REQUIRED
  infraChart.config.data.__rawCounts = rawCounts;

  infraChart.update();
};



/* ---------- ROAD BAR CHART ---------- */
new Chart(
  document.getElementById('roadChart'),
  {
    type: 'bar',
    data: {
      labels: ['BT Road', 'CC Road'],
      datasets: [{
        data: [bt.toFixed(2), cc.toFixed(2)],
        backgroundColor: ['#7c3aed', '#22c55e']
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'top',
          formatter: (v) => v + ' km',
          font: { weight: 'bold', size: 12 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Length (km)'
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  }
);


// üì± MOBILE DONUT CHART
function createMobileDonut(counts){

  const ctx = document.getElementById('assetChartMobile');
  if (!ctx) return;

  if (mobileInfraChart) {
    mobileInfraChart.destroy();
  }

  mobileInfraChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ALL_INFRA_CATEGORIES,
      datasets: [{
        data: counts,
        backgroundColor: [
          '#2563eb',
          '#f97316',
          '#16a34a',
          '#0ea5e9',
          '#eab308',
          '#7c3aed'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '55%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 10,
            font: { size: 11 }
          }
        },
        datalabels: {
          color: '#ffffff',
          font: { weight: 'bold', size: 11 },
          formatter: v => v > 0 ? v : ''
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}


// üì± MOBILE ROAD CHART
new Chart(
  document.getElementById('roadChartMobile'),
  {
    type: 'bar',
    data: {
      labels: ['BT Road', 'CC Road'],
      datasets: [{
        data: [bt.toFixed(2), cc.toFixed(2)],
        backgroundColor: ['#7c3aed', '#22c55e']
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'top',
          formatter: (v) => v + ' km'
        }
      },
      scales: { y: { beginAtZero: true } }
    },
    plugins: [ChartDataLabels]
  }
);


document.getElementById('legendToggle').addEventListener('click', () => {
  const legend = document.getElementById('mapLegend');
  const btn = document.getElementById('legendToggle');

  if (legend.classList.contains('collapsed')) {
    legend.classList.remove('collapsed');
    btn.innerText = '‚àí';
  } else {
    legend.classList.add('collapsed');
    btn.innerText = '+';
  }
});


/* ---------- MOBILE DASHBOARD TOGGLE (FIXED) ---------- */
const mobileDashBtn = document.getElementById('mobileDashBtn');
const dashboard = document.querySelector('.dashboard');

if (mobileDashBtn) {
  mobileDashBtn.onclick = () => {
    dashboard.classList.toggle('open');

    // üî• IMPORTANT: resize charts AFTER dashboard becomes visible
    setTimeout(() => {
      if (window.mobileInfraChart) {
        window.mobileInfraChart.resize();
      }
    }, 300);
  };
}

}); // ‚úÖ CLOSE Promise.all
});


</script>
</body>
</html>
